# 標準ではインストールされていないパッケージを利用する

課題12のプログラムを書き換え、区切り文字列をタブ一つのみにしましょう。下記のように動作するプログラムを書いてください:

1. 「金額の合計」を「0」として、以下の処理を実行します。
2. **(A)** 標準入力から1行の入力を受け取ります。
3. 受け取った入力を、**タブ文字一つ**で区切った文字列のリストとして代入します。
4. 代入した文字列のリストの要素数が
    1. 「2」であれば、1つめの要素を「分類」、2つめの要素を「金額」が書かれた文字列として解釈して、「金額」を「金額の合計」に足して、再度**(A)**から実行します。
    2. 「1」でかつ、その要素が空文字列であれば、「金額の合計」を出力して、終了します。
    3. それ以外の場合は、「`Invalid input: <入力した文字列>`」という形式のメッセージを**例外としてスロー**し、終了します。

## 必要な知識

### `cabal install --lib`や`stack install`で外部のパッケージをインストールする

今回の課題では、文字列を任意の区切り文字列で分割できる、[Data.List.Split][1]というモジュールに入っている`splitOn`関数を使います。このモジュールは、[split][2]というパッケージに含まれるモジュールであり、splitパッケージはGHCをインストールしただけでは利用できません。追加でsplitパッケージをインストールする必要があります。

[1]: http://hackage.haskell.org/package/split-0.2.3.3/docs/Data-List-Split.html
[2]: http://hackage.haskell.org/package/split

インストールしていない状態で下記のように`import`を実行しても、`Could not find module ‘Data.List.Split’`などというエラーが出てきてしまいます。

```
ghci> import Data.List.Split

<no location info>: error:
    Could not find module ‘Data.List.Split’
    It is not a module in the current program, or in any known package.
```

というわけで、下記のように`cabal install --lib`コマンドを使ってパッケージをインストールしてみましょう:

```bash
shell> cabal install --lib split
Config file path source is default config file.
Config file /root/.cabal/config not found.
Writing default configuration to /root/.cabal/config
Warning: The package list for 'hackage.haskell.org' does not exist. Run 'cabal
update' to download it.
cabal: Unknown package "split".

```

おっと、失敗してしまったようです。初めて`cabal install`を実行した場合、上記のようなメッセージと共に失敗することがあります。解決方法は

```
Warning: The package list for 'hackage.haskell.org' does not exist. Run 'cabal
update' to download it.
```

と書かれているとおり、一度`cabal update`コマンドを実行してください:

```bash
shell> cabal update
Downloading the latest package list from hackage.haskell.org
Updated package list of hackage.haskell.org to the index-state 2022-03-27T08:38:23Z
```

改めて実行してみます:

```bash
shell> cabal install --lib split
Resolving dependencies...
Build profile: -w ghc-9.0.2 -O1
In order, the following will be built (use -v for more details):
 - split-0.2.3.4 (lib) (requires download & build)
Downloading  split-0.2.3.4
Downloaded   split-0.2.3.4
Configuring library for split-0.2.3.4..
Preprocessing library for split-0.2.3.4..
Building library for split-0.2.3.4..
[1 of 2] Compiling Data.List.Split.Internals ( src/Data/List/Split/Internals.hs, dist/build/Data/List/Split/Internals.o, dist/build/Data/List/Split/Internals.dyn_o )
[2 of 2] Compiling Data.List.Split  ( src/Data/List/Split.hs, dist/build/Data/List/Split.o, dist/build/Data/List/Split.dyn_o )
Installing library in /root/.cabal/store/ghc-9.0.2/incoming/new-23/root/.cabal/store/ghc-9.0.2/split-0.2.3.4-2d0d2721866bca1e9750f78806805739dcf553a77e66e7ec4e409d1108eb04c3/lib
```

※出力はご利用の環境や、すでにsplitパッケージをインストール済みか否かで変わりますのでご注意ください。

なお、stackを使ってGHCをインストールした場合は下記のように`stack install`コマンドを使ってください:

```bash
shell> stack install split
Writing implicit global project config file to: /root/.stack/global-project/stack.yaml
Note: You can change the snapshot via the resolver field there.
Using latest snapshot resolver: lts-19.0
[1 of 2] Compiling Main             ( /root/.stack/setup-exe-src/setup-mPHDZzAJ.hs, /root/.stack/setup-exe-src/setup-mPHDZzAJ.o )
[2 of 2] Compiling StackSetupShim   ( /root/.stack/setup-exe-src/setup-shim-mPHDZzAJ.hs, /root/.stack/setup-exe-src/setup-shim-mPHDZzAJ.o )
Linking /root/.stack/setup-exe-cache/x86_64-linux/tmp-Cabal-simple_mPHDZzAJ_3.4.1.0_ghc-9.0.2 ...
split> configure
split> Configuring split-0.2.3.4...
split> build
split> Preprocessing library for split-0.2.3.4..
split> Building library for split-0.2.3.4..
split> [1 of 2] Compiling Data.List.Split.Internals
split> [2 of 2] Compiling Data.List.Split
split> copy/register
split> Installing library in /root/.stack/snapshots/x86_64-linux/f26ff508d123d1a8c200009fcec8000eb14ab15ef90a3079cec50219d8e27ab0/9.0.2/lib/x86_64-linux-ghc-9.0.2/split-0.2.3.4-8X1jE248hsm
CErmcz78K1t
split> Registering library for split-0.2.3.4..
```

※こちらも出力は環境や、すでにsplitパッケージをインストール済みか否かで変わります。

### インストールした`split`パッケージをGHCiで試す

前節の手順で、`split`パッケージをインストールできました。使い方を学ぶためにもGHCi上で試してみましょう。

`cabal install --lib`で`split`パッケージをインストールした方は、下記の通り`ghci`コマンドを起動すれば普通に`import Data.List.Split`できるようになっています:

<!--
cabal update && cabal install --lib split
-->

```haskell
shell> ghci
Loaded package environment from /root/.ghc/x86_64-linux-9.0.2/environments/default
GHCi, version 9.0.2: https://www.haskell.org/ghc/  :? for help
ghci> import Data.List.Split
```

stackでGHCをインストールした方はこちらのとおり、`stack exec ghci`コマンドを使いましょう:

```haskell
shell> stack exec ghci
-- ... 省略 ...
ghci> import Data.List.Split
```

<!-- 脚注が使えるようになったら脚注に寄せたい -->
`stack ghci`というよく似た名前のコマンドもありますが、こちらは`stack exec ghci`とは少し用途が異なります（詳細は割愛します）。その関係で、起動する`ghci`コマンド自身にオプションが渡しづらいといった問題があるので、ここでは`stack exec ghci`を紹介しています。

いずれにしても、今度は`import Data.List.Split`しても特にエラーメッセージが表示されなかったはずです。これでちゃんと`Data.List.Split`をちゃんと`import`できました。使ってみましょう！

本課題の要件のとおり、文字列をタブで区切ってリストに変換するには、`Data.List.Split`モジュールの`splitOn`関数を次のように使います。第一引数に区切り文字（列）を、第二引数に分割したい文字列を与えましょう:

```haskell
ghci> splitOn "\t" "foo bar\tbaz"
["foo bar","baz"]
```

上記のとおり、文字列リテラルの中にタブ文字を書くには`\t`と書いてください。C言語などよくあるプログラミング言語と同様ですね。

引数の順番についても一点。第一引数ではなく第二引数に処理したい文字列を与える、という点に違和感を覚えた方もいらっしゃるかも知れません。実はこれはHaskellにおける関数全般で推奨されていることで、**主な処理対象である引数を最後**の引数にすることとなっています。他の多くのプログラミング言語とは逆の方針でしょうし、戸惑うのも無理はないでしょう。これにはHaskell固有の、ちゃんとしたメリットがあるのですが、申し訳なくもここでは詳細は割愛します。とにかくここでは、`splitOn`関数を含めHaskellの関数は、多くの場合「主な処理対象である引数を最後におく」ものだと覚えておいてください。

なお、`splitOn`は空文字列を与えたときの結果が`words`と異なるので注意しましょう:

```haskell
ghci> words ""
[]
ghci> splitOn "\t" ""
[""]
```

### パッケージがインストールされていることを確認する

以下は、当入門「Make Mistakes to Learn Haskell」を開発しているディレクトリーで実行した場合の出力です。

```
shell> stack exec ghc-pkg list
C:\Users\yuji-yamamoto\AppData\Local\Programs\stack\x86_64-windows\ghc-8.4.3\lib\package.conf.d
    Cabal-2.2.0.1
    Win32-2.6.1.0
    array-0.5.2.0
    base-4.11.1.0
    ... 省略 ...

C:\sr\snapshots\03cb0bbe\pkgdb
    ... 省略 ...
    split-0.2.3.3
    ... 省略 ...
```

出力結果には「パッケージデータベース」と呼ばれる、パッケージの情報が含まれるディレクトリーごとに、インストールされているパッケージの一覧が出力されます。  
先ほど`stack install split`コマンドを実行したので、splitパッケージが入っていますね。
